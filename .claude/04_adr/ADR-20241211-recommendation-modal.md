# ADR-20241211: 達成後のレコメンドモーダル機能

## ステータス
提案中

## コンテキスト

### 解決したい課題
ユーザーが投稿を達成した後、「次は何しよう...」と迷ってしまい、行動が止まってしまう問題がある。mitadake?のコアバリュー「見て終わり→やってみる」を循環させるため、達成直後にモチベーションを維持し、次のアクションへスムーズに誘導する仕組みが必要。

### 目的
- **モチベーション維持:** 達成後の高揚感を活かして、次のアクションへ連続して行動させる
- **コミュニティ形成:** 他ユーザーの投稿を見せることで刺激し合う環境を作る
- **発見性の向上:** 埋もれた投稿や新しい投稿にも公平に露出機会を与える

## 決定事項

### 1. 推薦データソース
**他ユーザーの投稿から推薦（コミュニティ全体）**

- 自分の投稿は除外
- 達成した投稿自体も除外
- 理由: コミュニティで刺激し合い、「この人もやってる！」という社会的証明効果を狙う

### 2. 推薦アルゴリズム
**同じカテゴリからランダム抽出 + フォールバック**

```ruby
# 推薦ロジック（疑似コード）
def recommended_posts(limit: 3)
  # Step 1: 同じカテゴリから取得
  same_category = Post.where(category: self.category)
                      .where.not(user: self.user)
                      .where.not(id: self.id)
                      .order('RANDOM()')
                      .limit(limit)

  # Step 2: 不足分をカテゴリ制約なしで補填
  if same_category.size < limit
    other_category = Post.where.not(id: same_category.pluck(:id) + [self.id])
                         .where.not(user: self.user)
                         .order('RANDOM()')
                         .limit(limit - same_category.size)

    same_category + other_category
  else
    same_category
  end
end
```

**判断基準:**
- **ランダム抽出:** 人気投稿への偏りをなくし、全投稿に公平な露出機会を与える
- **カテゴリ制約:** 適度な関連性を保ちつつ、セレンディピティも提供
- **フォールバック:** 投稿数が少ない初期段階でも機能するように、カテゴリを跨いで補填

**代替案として検討したが却下したもの:**
- 人気順（いいね/達成数）: 新しい投稿が埋もれる問題
- 自分の過去投稿: 発見性がゼロ、コミュニティ感が生まれない
- YouTube API: 外部依存、料金発生、mitadake?のコンセプトから外れる

### 3. 表示方法
**モーダル（ポップアップ）形式**

**表示タイミング:**
- 達成ボタン押下 → Achievement作成 → 即座にモーダル表示

**表示内容:**
- 推薦投稿3件（固定）
- 各投稿: YouTubeサムネイル + タイトル + チャンネル名 + 「見る」ボタン
- モーダル下部: 「あとで」リンク（モーダルを閉じる）

**UI/UX:**
- モバイルファーストデザイン
- 「minimal & bold」の美学（シンプルで大胆な演出）
- 達成直後の高揚感を最大限活かす

**代替案として検討したが却下したもの:**
- 専用ページ: ページ遷移が発生、達成の勢いが削がれる
- インライン表示: 達成の特別感が薄れる
- フラッシュメッセージ: ワンクッション入るのでモチベーション維持効果が弱い

### 4. エッジケース処理

#### ケース1: 推薦する投稿が0件の場合
カテゴリ制約を外して他カテゴリから補填する（上記アルゴリズムに含む）

#### ケース2: 推薦が1〜2件しかない場合
そのまま表示（3件に満たなくてもOK）

### 5. ユーザー操作フロー

```
[達成する] ボタンクリック
  ↓
Achievement作成（POST /posts/:id/achievements）
  ↓
モーダル表示（推薦3件）
  ↓
【A】「見る」ボタンクリック
    → モーダルを閉じて、その投稿詳細ページへ遷移
【B】「✕」または「あとで」クリック
    → モーダルを閉じて、達成した投稿詳細ページに留まる
```

## 実装方針

### 技術スタック
- **Turbo Frame:** モーダルの表示・非表示
- **Stimulus:** モーダルのオープン/クローズ制御
- **Tailwind CSS:** モーダルのスタイリング
- **RSpec:** 推薦ロジックとコントローラのテスト

### ファイル構成（案）
```
app/
├── controllers/
│   └── recommendations_controller.rb  # 推薦API（モーダル用）
├── views/
│   └── recommendations/
│       └── _modal.html.erb  # モーダル本体
├── models/
│   └── concerns/
│       └── recommendable.rb  # 推薦ロジック（Post concern）
└── javascript/
    └── controllers/
        └── recommendation_modal_controller.js  # Stimulus
```

### パフォーマンス考慮
- RANDOM()はインデックス使えないが、3件取得のみなので許容範囲
- 将来的に投稿数が10万件超えたら、事前計算したランキングテーブルも検討

### セキュリティ考慮
- 推薦対象は公開投稿のみ（現状は全て公開）
- `current_user`のスコープで自分の投稿は除外
- XSS対策: YouTubeタイトル/チャンネル名のサニタイズ（既存の投稿詳細と同じ）

## 影響範囲

### 新規追加
- `Recommendable` concern（Post モデル）
- `RecommendationsController`
- モーダルビュー
- Stimulus コントローラ

### 既存変更
- `AchievementsController#create`: レスポンスにTurbo Streamを追加してモーダル表示

### データベース
- 変更なし（既存テーブルのみ使用）

## 将来の拡張性

### Phase 2以降で検討
- **パーソナライズ:** ユーザーの過去達成履歴に基づく推薦
- **テキスト類似度:** アクションプランの内容が似ている投稿を推薦
- **協調フィルタリング:** 似た嗜好のユーザーが達成した投稿を推薦
- **ランキングテーブル:** 事前計算で高速化

### 計測したい指標
- モーダル表示率（達成数 / モーダル表示数）
- 推薦クリック率（推薦からの遷移数 / モーダル表示数）
- 推薦経由の達成率（推薦から達成した数 / 推薦クリック数）

## 参考資料
- なし（オリジナル設計）

## 決定日
2024-12-11

## 決定者
高橋新（プロジェクトオーナー）
