# ADR-20241211: マイページに達成カレンダー機能を追加（月表示版）

## ステータス

Accepted（承認済み）

## 変更履歴

- 2024-12-11 初版作成（直近30日表示）
- 2024-12-11 月表示に変更

## コンテキスト

### 背景

mitadake?は「見て終わり」を「やってみる」に変える行動変革プラットフォーム。ユーザーがYouTube動画から学んだことを実際に行動に移すことを支援している。

現在、達成機能は実装されているが、ユーザーが自分の**達成の蓄積**を視覚的に確認する方法がない。過去の達成を振り返ることで、モチベーション維持や継続的な行動習慣の形成を促す必要がある。

### 解決したい課題

1. **達成の可視化**: ユーザーが自分の達成履歴を一目で把握できない
2. **モチベーション維持**: 継続的な行動変革を促す仕組みが弱い
3. **振り返りの難しさ**: 過去にどれだけ行動したかを確認しづらい

### 目標

- 達成履歴を月単位のカレンダー形式で視覚化
- シンプルで直感的なUI（mitadake?のデザインシステムに準拠）
- モバイルファーストのアプローチ

## 決定事項

### 1. 機能範囲（Phase 1）

```
✅ 達成カレンダー（今月のみ表示）
   - 日曜始まりのカレンダー形式
   - 曜日ヘッダー表示（日 月 火 水 木 金 土）
   - 達成日: #8B7355（ウォームブラウン）で塗りつぶし
   - 未達成日: #FAF8F5（クリーム）で表示
   - 空白セル: 何も表示しない

✅ 簡易統計
   - 総達成数（全期間）
   - 今月の達成数

✅ 表示場所
   - マイページ内に専用セクションとして追加

❌ Phase 1では実装しない
   - 月の切り替え（ドロップダウンや前月/次月ボタン）
   - クリックして達成投稿一覧表示
   - 達成パターン分析（平日/週末）
```

### 2. カレンダー表示仕様

**レイアウト:**
```
2024年12月

日 月 火 水 木 金 土
 1  2  3  4  5  6  7
 8  9 10 11 12 13 14
15 16 17 18 19 20 21
22 23 24 25 26 27 28
29 30 31 □ □ □ □  ← 空白セル
```

**仕様詳細:**
- 7列 × 5〜6行のグリッド
- 日曜始まり（日本の一般的なカレンダー）
- 月の最初の週の空白: 月初の曜日に応じて空白セルを配置
- 月の最後の週の空白: 月末後の余りは空白セルを配置
- デフォルト表示: 今月（`Date.current`）
- 月切り替え: Phase 2で実装予定

### 3. データ設計

既存の `achievements` テーブルを活用し、新規テーブルは作成しない。

```sql
-- 既存テーブル（変更なし）
CREATE TABLE achievements (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  post_id BIGINT NOT NULL,
  achieved_at DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  UNIQUE(user_id, post_id)
);
```

**必要なクエリ:**
```ruby
# 特定ユーザーの特定月の達成データを取得
Achievement
  .where(user_id: user_id)
  .where('achieved_at >= ? AND achieved_at <= ?', 
         Date.new(year, month, 1), 
         Date.new(year, month, -1))
  .group(:achieved_at)
  .count

# 例: { Date.new(2024,12,11) => 3, Date.new(2024,12,10) => 1, ... }
```

### 4. UI/UXデザイン

**デザイン原則:**
- mitadake?の「minimal & bold」美学に準拠
- ウォームベージュ配色（#FAF8F5, #8B7355, #4A4035）
- 大きめの角丸（rounded-lg）
- ゆったりした余白（gap-2, p-6）

**カレンダー表示:**
```
┌────────────────────────────────┐
│  達成カレンダー                │
│                                │
│  [統計: 総達成数 / 今月の達成]  │
│                                │
│  2024年12月                    │
│                                │
│  日 月 火 水 木 金 土           │
│  ┌──┬──┬──┬──┬──┬──┬──┐  │
│  │1 │2 │3 │4 │5 │6 │7 │  │
│  │  │■│■│  │■│  │■│  │
│  └──┴──┴──┴──┴──┴──┴──┘  │
│  ... (4〜5週間分)              │
│                                │
│  [凡例: 達成あり/なし]         │
└────────────────────────────────┘
```

**モバイル最適化:**
- 7列グリッド（`grid-cols-7`）
- 各セルは正方形（`aspect-square`）
- タップエリアは最低44x44px確保
- 曜日ヘッダーは小さめ（`text-xs`）

### 5. 技術スタック

| 項目 | 技術 | 理由 |
|------|------|------|
| バックエンド | Rails ActiveRecord | 既存のAchievementモデルを活用 |
| フロントエンド | ERB + Tailwind CSS | 既存のデザインシステムと統一 |
| データ取得 | SQL GROUP BY | パフォーマンス重視 |
| 日付計算 | Ruby Date/Time | 月初・月末・曜日計算 |

**パフォーマンス考慮:**
- 今月のみ取得（インデックス活用）
- ビューキャッシュ（`cache`ヘルパー）の活用
- N+1問題は発生しない（集計クエリのみ）

### 6. 実装方針

**ファイル構成:**
```
app/
├── controllers/
│   └── users_controller.rb  # show アクションを拡張
├── views/
│   └── users/
│       ├── show.html.erb  # 既存のマイページ
│       └── _achievement_calendar.html.erb  # 新規パーシャル
├── models/
│   └── achievement.rb  # 月単位の集計用スコープを追加
└── helpers/
    └── achievements_helper.rb  # カレンダー生成ロジック
```

**実装の流れ:**
1. `Achievement`モデルに月単位のスコープ追加
2. `UsersController#show`でカレンダーデータ取得
3. `AchievementsHelper`にカレンダーグリッド生成ロジック追加
4. パーシャルでカレンダー描画
5. Tailwind CSSでスタイリング
6. RSpecでテスト作成

## 影響範囲

### 新規追加
- `app/views/users/_achievement_calendar.html.erb`
- `app/helpers/achievements_helper.rb`（カレンダー生成ロジック）
- `Achievement`モデルに月単位スコープ追加

### 既存変更
- `app/controllers/users_controller.rb` - `show`アクションにデータ取得追加
- `app/views/users/show.html.erb` - カレンダーパーシャルを埋め込み

### データベース
- **変更なし**（既存の`achievements`テーブルを活用）

### パフォーマンス
- 今月の集計クエリ（1クエリのみ、軽量）
- ビューキャッシュで2回目以降は高速化

## 代替案と却下理由

### 案1: 直近30日表示
- **却下理由**: カレンダーとして月をまたぐと分かりづらい。月単位の方が直感的。

### 案2: 月切り替えを Phase 1 で実装
- **却下理由**: Phase 1はシンプルさ優先。ユーザーフィードバックを得てから Phase 2 で追加。

### 案3: 月曜始まり（ISO 8601）
- **却下理由**: 日本では日曜始まりが一般的。ユーザーの慣れを優先。

### 案4: 前月・次月の日付を薄く表示
- **却下理由**: Phase 1はシンプルさ優先。空白セルで十分。

## セキュリティ考慮

- `current_user`のスコープでデータ取得（他ユーザーの達成は見えない）
- XSS対策: ERBの自動エスケープを活用
- 認可: Deviseの`authenticate_user!`で保護済み

## テスト計画

### モデルテスト
```ruby
# spec/models/achievement_spec.rb
describe '.monthly_calendar_data' do
  it '指定月の達成をグループ化して返す'
  it '他の月の達成は含まれない'
  it '他ユーザーの達成は含まれない'
end
```

### ヘルパーテスト
```ruby
# spec/helpers/achievements_helper_spec.rb
describe '#generate_monthly_calendar' do
  it '月の全日付を含む配列を生成する'
  it '月初の空白セルを正しく配置する'
  it '月末の空白セルを正しく配置する'
  it '達成データと日付をマッピングする'
end
```

### システムテスト
```ruby
# spec/system/achievement_calendar_spec.rb
it 'マイページに達成カレンダーが表示される'
it '今月のカレンダーが表示される'
it '曜日ヘッダーが表示される'
it '達成日が正しく塗りつぶされる'
```

## マイルストーン

### Phase 1（本PR）: MVP実装
- 月表示カレンダー（今月のみ）
- 曜日ヘッダー
- 簡易統計（総達成数、今月の達成数）
- マイページ統合

### Phase 2（将来）: 拡張機能
- 月切り替え機能（ドロップダウンまたは前月/次月ボタン）
- クリックで達成投稿一覧表示（モーダル）
- 達成パターン分析（平日/週末、時間帯）
- 過去の月への遡及

### Phase 3（将来）: ゲーミフィケーション
- バッジシステム
- レベル/ランク
- チャレンジ機能

## 参考資料

- 一般的なカレンダーアプリ（Googleカレンダー、Apple Calendar）
- DotHabit（習慣化アプリ）
- GitHubコントリビューショングラフ
- mitadake? デザインシステム（`.claude/01_technical_design/04_design_system.md`）

## 決定日

2024-12-11

## 決定者

高橋新（プロジェクトオーナー）

---

**備考:** 
Phase 1はシンプルさを最優先し、今月の達成状況を見える化することに集中。ユーザーフィードバックを得てから Phase 2 以降の機能（月切り替え等）を検討する。