# ADR-20251229: 期日中心設計への移行とソーシャル機能の強化

## ステータス
承認済み

## コンテキスト

mitadake?は「見て終わり」を「やってみる」に変えることをコンセプトとしたYouTube動画からのアクションプラン実践支援アプリです。

現在の設計では以下の課題がありました：

1. **カテゴリ機能が使われていない**
   - YouTubeの15種類のカテゴリを導入したが、実際の利用では機能していない
   - 期日や達成状況の方がユーザーにとって重要

2. **リマインダー機能が複雑**
   - 1投稿に複数のリマインダーを設定可能
   - 目標達成の「期日」という概念が不明確
   - リマインダーが任意項目のため、設定しないユーザーが多い

3. **いいね機能が実践支援というコンセプトにそぐわない**
   - 単なる「いいね」では行動支援の要素が弱い
   - 期日が近づいている投稿を応援する仕組みがない

4. **投稿一覧のUI**
   - カテゴリや達成状況での絞り込みが複雑
   - 期日に基づいた優先度が見えにくい

---

## 決定事項

### 1. カテゴリ機能の削除

**変更前：**
```ruby
# posts テーブル
- category: integer (enum)
```

**変更後：**
- `category` カラムを削除
- カテゴリ関連のUI（ドロップダウン、絞り込み）を削除

**理由：**
カテゴリはユーザーにとって価値が低く、期日や達成状況の方が重要であるため。

---

### 2. リマインダー機能を期日機能に統合

**変更前：**
```ruby
# reminders テーブル
- post_id, reminder_at
- 1投稿に複数設定可能
- 任意項目
```

**変更後：**
```ruby
# posts テーブルに deadline カラムを追加
- deadline: date (必須)
- 1投稿につき1つの期日
- 投稿作成時に必須入力
```

**期日切れ通知：**
- 期日当日の0時に自動通知
- 通知内容：「【期日切れ】『〇〇』の期日が過ぎました。達成できましたか?」
- 通知のみ（追加のアクションボタンなし）

**理由：**
- 目標達成の期日を明確にするため
- 1投稿1期日のシンプルな設計にするため
- 必須項目にすることで、すべての投稿に期日の概念を持たせる

---

### 3. いいね機能を応援機能に変更

**変更前：**
```ruby
# likes テーブル
- user_id, post_id
```

**変更後：**
```ruby
# cheers テーブルに改名
- user_id, post_id
- 1投稿につき1ユーザー1回のみ
- モデル名：Cheer
```

**UI変更：**
- 「いいね」ボタン → 「応援する」ボタン
- ハートアイコン → 応援アイコン（検討中）

**通知連携：**
- 応援時に投稿者に通知
- 通知内容：「〇〇さんがあなたの投稿を応援しました」

**理由：**
期日が近づいている投稿に他のユーザーがエールを送れるようにし、実践支援のコンセプトを強化するため。

---

### 4. 期日によるグループ表示

**変更前：**
- 投稿一覧は作成日順
- カテゴリ、達成状況でフィルタリング

**変更後：**
- 期日に基づく3グループで表示

| グループ | 条件 | 表示順 |
|----------|------|--------|
| 期日が近い | 期日が3日以内 | 期日の近い順 |
| 期日超過 | 期日を過ぎている | 期日の古い順 |
| その他 | 期日が4日以上先 | 期日の近い順 |

**グループUI：**
- 各グループはアコーディオン形式で折りたたみ可能
- グループヘッダーに件数表示
- デフォルトは全グループ展開

**絞り込みとの連携：**
- 「全体/自分」トグルは維持
- グループ表示は維持したまま絞り込み適用

**理由：**
期日を中心にした設計により、ユーザーが優先度の高い投稿を把握しやすくするため。

---

### 5. 全体/自分トグルボタンの簡素化

**変更前：**
```
[ タブ ]
- 全体 / 自分

[ ドロップダウン絞り込み ]
- カテゴリ
- 達成状況
- リマインダー
```

**変更後：**
```
[ iOS風トグルスイッチ ]
全体  ━━●━  自分
```

**配置：**
- 検索バーの近く
- 両側にラベル表示

**動作：**
- トグル切り替え時もグループ表示を維持
- 各グループに絞り込み結果を表示
- 検索との併用可能

**理由：**
UIをシンプルにし、期日グループ表示に集中するため。カテゴリ削除により絞り込み項目が減少したため。

---

### 6. アプリ内通知機能の追加

**実装方法：**
- Activity Notification gem を使用
- 使用機能：通知の作成・一覧・既読管理・未読数カウント
- 使用しない機能：グルーピング、メール通知、SMS通知

**通知の種類：**

| 種類 | トリガー | 内容 |
|------|----------|------|
| 応援 | 他ユーザーが応援 | 「〇〇さんがあなたの投稿を応援しました」 |
| コメント | 他ユーザーがコメント | 「〇〇さんがコメントしました」 |
| 期日切れ | 期日当日0時（バッチ） | 「【期日切れ】『〇〇』の期日が過ぎました」 |

**通知UI：**
- ボトムナビに通知タブ追加
- 未読数バッジ表示
- 通知一覧ページ
- 一括既読ボタン

---

### 7. タブバーの拡張

**変更前：**
```
[ ホーム ] [ + ] [ 本棚 ] [ マイページ ]
```

**変更後：**
```
[ ホーム ] [ + ] [ 本棚 ] [ 🔔 ] [ マイページ ]
```

**通知タブの配置：**
- 本棚とマイページの間（右から2番目）

**理由：**
通知機能を追加するため。5つのタブでも視認性を保てる。

---

## 検討した選択肢

### 応援機能のテーブル名

| 選択肢 | メリット | デメリット | 採用 |
|--------|----------|------------|------|
| `likes` をそのまま流用 | マイグレーション不要 | 意味的に「応援」とズレる | ✗ |
| `cheers` に改名 | 「応援」のニュアンスに近い | マイグレーション必要 | ✓ |
| `supports` に改名 | 「支援」の意味で自然 | やや堅い印象 | ✗ |

**採用理由：** `cheers` が「応援」のニュアンスに最も近く、コードの可読性が高いため。

---

### 通知機能の実装方法

| 選択肢 | メリット | デメリット | 採用 |
|--------|----------|------------|------|
| Activity Notification gem | 多機能、既読管理が容易 | 学習コスト | ✓ |
| 自前実装 | カスタマイズ性が高い | 開発コスト大 | ✗ |
| Noticed gem | シンプル | 機能が少ない | ✗ |

**採用理由：** Activity Notification gemは通知の作成・一覧・既読管理が一通り揃っており、必要な機能を効率的に実装できるため。

---

## 技術設計

### データベース

**追加：**
```ruby
# posts テーブル
add_column :posts, :deadline, :date, null: false
```

**削除：**
```ruby
# posts テーブル
remove_column :posts, :category

# reminders テーブル
drop_table :reminders
```

**改名：**
```ruby
# likes テーブル → cheers テーブル
rename_table :likes, :cheers
```

**Activity Notification gem による追加：**
```ruby
# notifications テーブル（gem が自動生成）
```

---

### モデル

**Post モデル：**
- `deadline` バリデーション追加（必須、未来日）
- `category` enum 削除
- リマインダー関連のアソシエーション削除（`has_many :reminders`）
- 期日グループ分けのスコープ追加
  - `scope :deadline_near` (3日以内)
  - `scope :deadline_passed` (期日超過)
  - `scope :deadline_other` (4日以上)

**削除：**
- `Reminder` モデル

**改名：**
- `Like` モデル → `Cheer` モデル

**追加：**
- `Notification` モデル（Activity Notification gem）

---

### コントローラー

**変更：**
- `PostsController`: カテゴリ関連のパラメータ削除、期日パラメータ追加
- `LikesController` → `CheersController` に改名

**削除：**
- `RemindersController`

**追加：**
- `NotificationsController`: 通知一覧、既読処理

---

### ビュー

**投稿フォーム：**
- カテゴリ選択を削除
- 期日入力を追加（必須、日付ピッカー）

**投稿一覧：**
- グループ表示（Stimulus）
- トグルスイッチ（Tailwind CSS）
- 期日表示の強調（デザイン検討中）

**その他：**
- いいねボタン → 応援ボタン
- 通知タブ追加
- タブバー拡張（5つに）

---

### バックグラウンドジョブ

**追加：**
```ruby
# 期日切れ通知バッチ（毎日0時実行）
class DeadlineNotificationJob < ApplicationJob
  queue_as :default

  def perform
    # 期日が今日で未達成の投稿を取得
    # 投稿者に通知を作成
  end
end
```

**削除：**
- リマインダー送信ジョブ（`ReminderNotificationJob`）

**sidekiq-scheduler 設定：**
```yaml
# config/sidekiq.yml
:schedule:
  deadline_notification:
    cron: '0 0 * * *'  # 毎日0時
    class: DeadlineNotificationJob
```

---

### ルーティング

**削除：**
```ruby
resources :reminders
```

**改名：**
```ruby
# 変更前
resources :posts do
  resources :likes, only: [:create, :destroy]
end

# 変更後
resources :posts do
  resources :cheers, only: [:create, :destroy]
end
```

**追加：**
```ruby
resources :notifications, only: [:index] do
  collection do
    post :mark_all_as_read
  end
end
```

---

### i18n

```yaml
# config/locales/ja.yml
ja:
  activerecord:
    attributes:
      post:
        deadline: 期日
  posts:
    deadline_near: 期日が近い投稿
    deadline_passed: 期日超過の投稿
    deadline_other: その他の投稿
  cheers:
    create: 応援しました
    destroy: 応援を取り消しました
  notifications:
    title: 通知
    mark_all_as_read: すべて既読にする
    types:
      cheer: "%{actor}さんがあなたの投稿を応援しました"
      comment: "%{actor}さんがコメントしました"
      deadline_passed: "【期日切れ】『%{action_plan}』の期日が過ぎました。達成できましたか?"
```

---

## 移行計画

### Phase 1: データベース変更（Week 1）

**タスク：**
1. `posts.deadline` カラム追加マイグレーション
2. 既存データに `deadline` を設定（`created_at + 7.days` など）
3. `posts.category` カラム削除マイグレーション
4. `likes` テーブルを `cheers` に改名マイグレーション
5. `reminders` テーブル削除マイグレーション

**注意点：**
- 本番環境のデータはほぼないため、影響は最小限
- 既存の `likes` データは `cheers` に自動移行される

---

### Phase 2: 応援機能実装（Week 1）

**タスク：**
1. `Like` モデル → `Cheer` モデルに改名
2. `LikesController` → `CheersController` に改名
3. ルーティング変更
4. ビュー変更（ボタン、アイコン、テキスト）
5. i18n 更新
6. テスト更新

**テスト要件：**
- 新規コード行の80%以上カバー
- RuboCop, Brakeman → All green

---

### Phase 3: グループ表示実装（Week 2）

**タスク：**
1. `Post` モデルに期日グループ分けのスコープ追加
2. 折りたたみUIコンポーネント実装（Stimulus）
3. グループヘッダー、カウント表示
4. グループ内のソート実装
5. 全体/自分トグルとの連携
6. 検索との連携（グループ維持）

**テスト要件：**
- グループ分けのスコープのユニットテスト
- 折りたたみ動作のシステムテスト

---

### Phase 4: 通知機能実装（Week 2-3）

**タスク：**
1. Activity Notification gem 導入
2. `Notification` モデル、コントローラー作成
3. 通知タブUI実装
4. タブバー拡張（5つに）
5. 応援時の通知トリガー実装
6. コメント時の通知トリガー実装
7. 期日切れバッチ処理実装（Sidekiq）
8. sidekiq-scheduler 設定
9. 未読バッジ表示
10. 一括既読ボタン

**テスト要件：**
- 通知作成のユニットテスト
- バッチ処理のジョブテスト
- 通知一覧のシステムテスト

---

### Phase 5: クリーンアップ（Week 3）

**タスク：**
1. `Reminder` モデル削除
2. `RemindersController` 削除
3. リマインダー関連のビュー削除
4. カテゴリ関連のコード削除
5. 不要なi18nキー削除
6. 古いテスト削除

---

## テスト要件

### RSpec
- 新規コード行の80%以上カバレッジ
- モデル：バリデーション、スコープ、メソッド
- コントローラー：CRUD、認可、通知トリガー
- ジョブ：期日切れバッチ処理
- システムテスト：折りたたみグループ、トグル、通知

### 静的解析
- RuboCop → All green
- Brakeman → All green
- bundle audit → All green

### パフォーマンス
- N+1クエリなし（includes 使用）
- ページネーション（Kaminari）

### i18n
- 日本語キー存在確認

### A11y
- フォームラベル
- alt 属性

---

## リスク

### データ移行
- **既存の `reminders` データは削除される**
  - 対策：本番データはほぼないため影響は最小限

- **既存の `likes` データは `cheers` に移行される**
  - 対策：データ構造は同じなので問題なし

- **既存の投稿に `deadline` を手動設定する必要がある**
  - 対策：開発環境のテストデータのみ。デフォルト値（created_at + 7日）を設定

### Activity Notification gem
- **gem のバージョンアップによる影響**
  - 対策：バージョン固定、定期的な更新確認

### パフォーマンス
- **通知テーブルの肥大化**
  - 対策：古い通知の定期削除バッチ検討

---

## 結論

期日中心設計への移行により、mitadake?の「実践支援」というコンセプトを強化します。カテゴリやリマインダーといった複雑な機能を削除し、シンプルで直感的なUI/UXを実現します。応援機能と通知機能により、ソーシャル要素を強化し、ユーザー同士が目標達成を支え合える仕組みを構築します。

---

## 参照

- [Activity Notification gem](https://github.com/simukappu/activity_notification)
- [sidekiq-scheduler](https://github.com/sidekiq-scheduler/sidekiq-scheduler)

---

## 履歴

- 2024-12-29: 初版作成
