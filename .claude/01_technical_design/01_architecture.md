# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## æ¦‚è¦

ActionSparkã¯Ruby on Rails 7.2.2ã‚’åŸºç›¤ã¨ã—ãŸã€æ¨™æº–çš„ãªMVCã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤                         â”‚
â”‚  ãƒ–ãƒ©ã‚¦ã‚¶ (Turbo Drive + Turbo Frames + Stimulus)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Controllers â”‚  â”‚   Models    â”‚  â”‚   Views     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                â”‚                â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Concerns   â”‚  â”‚   Helpers   â”‚  â”‚ ViewComponentâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ãƒ‡ãƒ¼ã‚¿å±¤                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚    Redis    â”‚  â”‚  S3 (ç”»åƒ)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
app/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ application_controller.rb    # åŸºåº•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”‚   â”œâ”€â”€ posts_controller.rb          # æŠ•ç¨¿ç®¡ç†
â”‚   â”œâ”€â”€ achievements_controller.rb   # é”æˆè¨˜éŒ²
â”‚   â”œâ”€â”€ comments_controller.rb       # ã‚³ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ likes_controller.rb          # ã„ã„ã­
â”‚   â””â”€â”€ users/                       # Deviseé–¢é€£
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ application_record.rb
â”‚   â”œâ”€â”€ user.rb
â”‚   â”œâ”€â”€ post.rb
â”‚   â”œâ”€â”€ achievement.rb
â”‚   â”œâ”€â”€ comment.rb
â”‚   â””â”€â”€ like.rb
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ layouts/
â”‚   â”œâ”€â”€ posts/
â”‚   â”œâ”€â”€ shared/                      # ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«
â”‚   â””â”€â”€ devise/                      # èªè¨¼ç”»é¢
â”œâ”€â”€ javascript/
â”‚   â””â”€â”€ controllers/                 # Stimulus ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”œâ”€â”€ helpers/
â””â”€â”€ assets/
    â””â”€â”€ stylesheets/
```

## ãƒ¬ã‚¤ãƒ¤ãƒ¼è²¬å‹™

### Controllerå±¤

- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä¿¡ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆStrong Parametersï¼‰
- èªè¨¼ãƒ»èªå¯ã®ãƒã‚§ãƒƒã‚¯
- ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

```ruby
# è‰¯ã„ä¾‹ï¼šã‚·ãƒ³ãƒ—ãƒ«ã§è²¬å‹™ãŒæ˜ç¢º
class PostsController < ApplicationController
  before_action :authenticate_user!, except: [:index, :show]
  before_action :set_post, only: [:show, :edit, :update, :destroy]

  def create
    @post = current_user.posts.build(post_params)
    if @post.save
      redirect_to @post, notice: 'æŠ•ç¨¿ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      render :new, status: :unprocessable_entity
    end
  end

  private

  def post_params
    params.require(:post).permit(:trigger_content, :action_plan, :category)
  end
end
```

### Modelå±¤

- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¹ã‚³ãƒ¼ãƒ—
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

```ruby
# è‰¯ã„ä¾‹ï¼šãƒ¢ãƒ‡ãƒ«ã«é©åˆ‡ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’é…ç½®
class Post < ApplicationRecord
  belongs_to :user
  has_many :achievements, dependent: :destroy
  has_many :comments, dependent: :destroy
  has_many :likes, dependent: :destroy

  validates :trigger_content, presence: true, length: { maximum: 100 }
  validates :action_plan, presence: true, length: { maximum: 100 }

  scope :recent, -> { order(created_at: :desc) }
  scope :by_category, ->(category) { where(category: category) if category.present? }

  def achieved_today_by?(user)
    achievements.exists?(user: user, achieved_on: Date.current)
  end
end
```

### Viewå±¤

- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
- Turbo Frames/Streamsã®æ´»ç”¨
- ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«ã«ã‚ˆã‚‹å†åˆ©ç”¨

```erb
<%# è‰¯ã„ä¾‹ï¼šTurbo Frameã§ã®éƒ¨åˆ†æ›´æ–° %>
<%= turbo_frame_tag dom_id(@post) do %>
  <div class="post-card">
    <%= render 'posts/content', post: @post %>
    <%= render 'posts/actions', post: @post %>
  </div>
<% end %>
```

## Concernè¨­è¨ˆ

å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã¯Concernã§åˆ‡ã‚Šå‡ºã—ã€å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã¾ã™ã€‚

```ruby
# app/models/concerns/achievable.rb
module Achievable
  extend ActiveSupport::Concern

  included do
    has_many :achievements, dependent: :destroy
  end

  def total_achievements
    achievements.count
  end

  def achievement_badge
    case total_achievements
    when 0 then 'â˜†'
    when 1 then 'â­'
    when 2 then 'ğŸ”¥'
    when 3 then 'ğŸ†'
    else 'ğŸ‘‘'
    end
  end
end
```

## Service Objectï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯Serviceã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚

```ruby
# app/services/achievement_recorder.rb
class AchievementRecorder
  def initialize(user, post)
    @user = user
    @post = post
  end

  def call
    return { success: false, error: 'æœ¬æ—¥ã¯æ—¢ã«é”æˆæ¸ˆã¿ã§ã™' } if already_achieved_today?

    achievement = @post.achievements.create!(
      user: @user,
      achieved_on: Date.current
    )

    { success: true, achievement: achievement }
  rescue ActiveRecord::RecordInvalid => e
    { success: false, error: e.message }
  end

  private

  def already_achieved_today?
    @post.achievements.exists?(user: @user, achieved_on: Date.current)
  end
end
```

## è¨­è¨ˆåŸå‰‡

1. **Fat Model, Skinny Controller**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯Modelã«
2. **DRY**: é‡è¤‡ã‚³ãƒ¼ãƒ‰ã¯Concernã‚„Helperã«
3. **KISS**: ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’ä¿ã¤
4. **Convention over Configuration**: Railsè¦ç´„ã«å¾“ã†

## æ³¨æ„äº‹é …

- N+1å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã€`includes`ã‚’é©åˆ‡ã«ä½¿ç”¨
- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ç›´æ¥ãƒ¢ãƒ‡ãƒ«ã‚’æ“ä½œã›ãšã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ´»ç”¨
- è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¯ã‚¹ã‚³ãƒ¼ãƒ—ã«ã¾ã¨ã‚ã‚‹
- Turbo Streamsä½¿ç”¨æ™‚ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«æ³¨æ„ï¼ˆbroadcastå…ˆã®åˆ¶å¾¡ï¼‰

---

*é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ*: `02_database.md`, `03_api_design.md`
