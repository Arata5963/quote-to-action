<%# app/views/posts/index.html.erb %>

<div class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6">

    <%# ===== Search / Filters Bar ===== %>
    <section class="mb-8">
      <div class="rounded-2xl bg-white border border-accent/20 shadow-sm p-5">
        <%= search_form_for @q, url: posts_path, method: :get,
              html: { id: 'search_form', class: "space-y-4" } do |f| %>

          <%# 検索フィールド + 検索ボタン（横並び） %>
          <div class="flex gap-3">
            <div class="relative flex-1"
                 data-controller="autocomplete"
                 data-autocomplete-url-value="<%= autocomplete_posts_path %>"
                 data-autocomplete-min-length-value="2"
                 role="combobox">
              <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4 z-10">
                <svg class="h-5 w-5 text-primary/40" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
              <%= f.search_field :action_plan_or_youtube_title_or_youtube_channel_name_cont,
                    data: { autocomplete_target: "input" },
                    placeholder: "キーワードで検索...",
                    class: "w-full rounded-xl border-accent/20 bg-cream pl-12 pr-4 py-3 text-sm text-primary placeholder:text-primary/40 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:bg-white transition-all" %>
              <ul class="absolute z-20 w-full bg-white border border-accent/20 rounded-xl shadow-lg mt-1 max-h-60 overflow-y-auto"
                  data-autocomplete-target="results"
                  hidden></ul>
            </div>

            <%# 検索ボタン %>
            <button type="submit" class="rounded-xl bg-accent text-white px-6 py-3 text-sm font-medium hover:bg-accent/90 transition-colors flex-shrink-0">
              検索
            </button>
          </div>

          <%# フィルター（横並び・中央寄せ） %>
          <div class="flex flex-wrap gap-4 justify-center">
            <%# 表示タブ %>
            <div>
              <label class="text-xs text-primary/60 mb-1 block">投稿</label>
              <%= select_tag :tab,
                    options_for_select(
                      [
                        ['全体', ''],
                        user_signed_in? ? ['自分の投稿', 'mine'] : nil
                      ].compact,
                      params[:tab]
                    ),
                    class: "rounded-lg border-accent/20 bg-white px-3 py-2 text-sm text-primary/80 focus:border-accent focus:ring-2 focus:ring-accent/20",
                    onchange: "document.getElementById('search_form').submit()" %>
            </div>

            <%# 達成状況 %>
            <div>
              <label class="text-xs text-primary/60 mb-1 block">達成状況</label>
              <%= select_tag :achievement,
                    options_for_select(
                      [
                        ['すべて', ''],
                        ['達成済み', 'achieved'],
                        ['みただけ？', 'not_achieved']
                      ],
                      params[:achievement]
                    ),
                    class: "rounded-lg border-accent/20 bg-white px-3 py-2 text-sm text-primary/80 focus:border-accent focus:ring-2 focus:ring-accent/20",
                    onchange: "document.getElementById('search_form').submit()" %>
            </div>

            <%# 期日 %>
            <div>
              <label class="text-xs text-primary/60 mb-1 block">期日</label>
              <%= select_tag :deadline,
                    options_for_select(
                      [
                        ['すべて', ''],
                        ['期日あり', 'with_deadline'],
                        ['期限切れ', 'overdue']
                      ],
                      params[:deadline]
                    ),
                    class: "rounded-lg border-accent/20 bg-white px-3 py-2 text-sm text-primary/80 focus:border-accent focus:ring-2 focus:ring-accent/20",
                    onchange: "document.getElementById('search_form').submit()" %>
            </div>
          </div>
        <% end %>
      </div>
    </section>

    <%# ===== Posts List ===== %>
    <% if @group_display %>
      <%# ===== グループ表示モード ===== %>
      <% total_count = @posts_near.size + @posts_passed.size + @posts_other.size + @posts_achieved.size %>

      <% if total_count == 0 %>
        <%= render 'posts/empty_state' %>
      <% else %>
        <%# 期日が近い（3日以内） %>
        <% if @posts_near.any? %>
          <%= render layout: 'posts/group_header',
                locals: {
                  title: '期日が近い',
                  badge_count: @posts_near.size,
                  badge_color: 'amber-600',
                  icon_svg: '<svg class="h-5 w-5 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'.html_safe,
                  open: true
                } do %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <% @posts_near.each do |post| %>
                <%= render 'posts/post_card', post: post %>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <%# 期日超過 %>
        <% if @posts_passed.any? %>
          <%= render layout: 'posts/group_header',
                locals: {
                  title: '期日超過',
                  badge_count: @posts_passed.size,
                  badge_color: 'red-500',
                  icon_svg: '<svg class="h-5 w-5 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>'.html_safe,
                  open: true
                } do %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <% @posts_passed.each do |post| %>
                <%= render 'posts/post_card', post: post %>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <%# その他（4日以上先） %>
        <% if @posts_other.any? %>
          <%= render layout: 'posts/group_header',
                locals: {
                  title: 'まだ余裕あり',
                  badge_count: @posts_other.size,
                  badge_color: 'accent',
                  icon_svg: '<svg class="h-5 w-5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>'.html_safe,
                  open: true
                } do %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <% @posts_other.each do |post| %>
                <%= render 'posts/post_card', post: post %>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <%# 達成済み（最新10件） %>
        <% if @posts_achieved.any? %>
          <%= render layout: 'posts/group_header',
                locals: {
                  title: '達成済み',
                  badge_count: @posts_achieved.size,
                  badge_color: 'green-500',
                  icon_svg: '<svg class="h-5 w-5 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'.html_safe,
                  open: false
                } do %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <% @posts_achieved.each do |post| %>
                <%= render 'posts/post_card', post: post %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>

    <% else %>
      <%# ===== 通常表示モード（フィルター使用時） ===== %>
      <% if @posts.empty? %>
        <%= render 'posts/empty_state' %>
      <% else %>
        <%# 投稿リスト - 2カラムグリッド %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <% @posts.each do |post| %>
            <%= render 'posts/post_card', post: post %>
          <% end %>
        </div>

        <%# Pagination %>
        <div class="mt-10">
          <%= paginate @posts %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
