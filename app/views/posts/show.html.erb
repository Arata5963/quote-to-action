<%# app/views/posts/show.html.erb %>
<% content_for :title, @post.trigger_content.truncate(30) %>

<div class="max-w-3xl mx-auto px-4 py-8">
  
  <%# ページ上部のヘッダー情報 %>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-2">投稿詳細</h1>
    <div class="text-sm text-gray-500 flex items-center justify-between">
      <span><%= @post.created_at.strftime("%Y年%m月%d日 %H:%M") %></span>
      <span class="text-blue-600">投稿者: <%= @post.user.email %></span>
    </div>
  </div>

  <%# 投稿カード（左画像／右テキスト＋達成ボタン + 右上に編集/削除アイコン） %>
  <div class="relative bg-white border rounded-lg hover:shadow-md transition mb-6">
    
    <%# 右上：編集/削除（所有者のみ表示） %>
    <% if @post.user == current_user %>
      <div class="absolute right-2 top-2 z-10 flex items-center gap-1">
        <%# 編集アイコン %>
        <%= link_to edit_post_path(@post),
              class: "inline-flex p-2 rounded-md text-gray-500 hover:text-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500",
              aria: { label: "編集" }, title: "編集" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16.862 3.487a2.25 2.25 0 013.182 3.182l-9.546 9.546a4.5 4.5 0 01-1.598 1.012l-3.013 1.004a.75.75 0 01-.948-.948l1.004-3.013a4.5 4.5 0 011.012-1.598l9.546-9.546z" />
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M19.5 7.5L16.5 4.5" />
          </svg>
        <% end %>

        <%# 削除アイコン %>
        <%= link_to post_path(@post),
              data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
              class: "inline-flex p-2 rounded-md text-gray-500 hover:text-red-600 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500",
              aria: { label: "削除" }, title: "削除" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M14.74 9l-.346 9m-4.788 0L9.26 9M4.5 6.75h15m-10.125 0V5.25c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v1.5M6.375 6.75l.347 12.028a2.25 2.25 0 002.246 2.222h6.064a2.25 2.25 0 002.246-2.222L17.625 6.75" />
          </svg>
        <% end %>
      </div>
    <% end %>

    <div class="flex flex-col sm:flex-row">
      <!-- 左：画像 -->
      <div class="sm:w-48 sm:flex-shrink-0">
        <img
          alt=""
          src="https://images.unsplash.com/photo-1603871165848-0aa92c869fa1?ixlib=RB-1.2.1&auto=format&fit=crop&w=772&q=80"
          class="h-48 w-full sm:h-full sm:w-48 object-cover rounded-t-lg sm:rounded-l-lg sm:rounded-tr-none"
        />
      </div>

      <!-- 右：本文＋達成ボタン -->
      <div class="flex-1 p-4 sm:p-6 sm:pr-12 flex flex-col justify-between">
        <div>
          <!-- 達成回数 -->
          <div class="mb-2 text-xs text-pink-600 font-semibold">
            達成 <%= @post.achievements.where(user_id: @post.user.id).count %> 回
          </div>

          <!-- アクションプラン -->
          <div class="mb-3">
            <div class="text-xs text-gray-500">アクションプラン</div>
            <h3 class="text-lg font-bold text-gray-900 leading-snug">
              <%= @post.action_plan %>
            </h3>
          </div>

          <!-- きっかけ -->
          <div>
            <div class="text-xs text-gray-500">きっかけ</div>
            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">
              <%= @post.trigger_content %>
            </p>
          </div>
        </div>

        <!-- 右下：達成ボタン（所有者のみ） -->
        <% if @post.user == current_user %>
          <% done_today = @post.achievements.today.exists?(user_id: current_user.id) %>
          <div class="mt-4 self-end">
            <% unless done_today %>
              <%= button_to "今日の達成を記録", post_achievements_path(@post),
                    method: :post,
                    class: "bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md transition-colors font-medium" %>
            <% else %>
              <div class="bg-emerald-100 text-emerald-800 px-4 py-2 rounded-md text-center font-medium">
                今日は達成済みです ✅
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# 下部リンク：一覧に戻る（編集/削除はカード内で置き換えたため表示しない） %>
  <div class="mt-6 text-sm font-medium">
    <%= link_to "一覧に戻る", posts_path, class: "text-gray-600 hover:underline" %>
  </div>
</div>
