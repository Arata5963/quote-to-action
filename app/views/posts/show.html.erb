<%# app/views/posts/show.html.erb %>
<%# 投稿詳細表示ページ - ユーザーが投稿した「きっかけ」の詳細を表示し、達成機能も提供 %>

<%# ブラウザのタブに表示されるページタイトルを設定 %>
<%# trigger_contentの最初の30文字を使用してわかりやすいタイトルにする %>
<% content_for :title, @post.trigger_content.truncate(30) %>

<%# ページ全体のコンテナ - レスポンシブ対応で最大幅を制限 %>
<div class="max-w-3xl mx-auto px-4 py-8">
  
  <%# ページ上部のヘッダー情報 %>
  <div class="mb-8">
    <%# ページの主要なタイトル %>
    <h1 class="text-2xl font-bold text-gray-900 mb-2">投稿詳細</h1>
    <%# 投稿された日時を「年月日 時分」形式で表示 %>
    <div class="text-sm text-gray-500">
      <span><%= @post.created_at.strftime("%Y年%m月%d日 %H:%M") %></span>
    </div>
  </div>

  <%# 投稿内容を表示するメインカード %>
  <div class="bg-white border rounded-lg p-6 shadow-sm mb-6">
    
    <%# きっかけ（trigger_content）の表示セクション %>
    <div class="mb-6">
      <%# きっかけセクションの見出し %>
      <h2 class="text-lg font-semibold text-gray-800 mb-3">きっかけ</h2>
      <%# prose: Tailwind CSSの読みやすい文章スタイル %>
      <div class="prose max-w-none">
        <%# whitespace-pre-line: 改行文字を維持して表示 %>
        <%# leading-relaxed: 行間をゆったりと設定 %>
        <p class="text-gray-700 leading-relaxed whitespace-pre-line"><%= @post.trigger_content %></p>
      </div>
    </div>

    <%# アクションプラン（action_plan）の表示セクション %>
    <%# border-t: 上部にボーダーラインを追加してセクションを分ける %>
    <div class="border-t pt-6">
      <%# アクションプランセクションの見出し %>
      <h2 class="text-lg font-semibold text-gray-800 mb-3">アクションプラン</h2>
      <div class="prose max-w-none">
        <%# アクションプランの内容を改行を保持して表示 %>
        <p class="text-gray-700 leading-relaxed whitespace-pre-line"><%= @post.action_plan %></p>
      </div>
    </div>
  </div>

  <%# 達成機能セクション - 1日1回の達成記録機能を提供 %>
  <%# bg-emerald-50: 薄い緑色の背景で達成機能を目立たせる %>
  <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-6 mb-6">
    
    <%# 今日既に達成済みかどうかをチェック %>
    <%# today スコープ: awarded_at が今日の日付のレコード %>
    <%# exists?: 条件に合うレコードが存在するかの真偽値を返す %>
    <% done_today = @post.achievements.today.exists?(user_id: current_user.id) %>
    
    <%# セクションのヘッダー部分 - タイトルと累計回数を横並びで配置 %>
    <div class="flex items-center justify-between mb-4">
      <%# セクションタイトル %>
      <h3 class="text-lg font-semibold text-emerald-800">今日のアクション</h3>
      
      <%# 累計達成回数の表示エリア %>
      <div class="text-right">
        <%# 小さなラベルテキスト %>
        <div class="text-sm text-emerald-600">累計達成回数</div>
        <%# 大きく目立つ数字表示 %>
        <%# where(user_id: current_user.id): 現在のユーザーの達成記録のみを抽出 %>
        <%# count: 該当レコード数をカウント %>
        <div class="text-2xl font-bold text-emerald-700">
          <%= @post.achievements.where(user_id: current_user.id).count %> 回
        </div>
      </div>
    </div>

    <%# 達成状況に応じて表示内容を切り替え %>
    <% unless done_today %>
      <%# 今日未達成の場合: 達成記録ボタンを表示 %>
      <%# button_to: フォーム送信ボタン（POST リクエスト）を生成 %>
      <%# post_achievements_path(@post): /posts/:id/achievements へのパス %>
      <%# method: :post: HTTP POST メソッドでリクエスト送信 %>
      <%= button_to "今日の達成を記録", post_achievements_path(@post),
            method: :post,
            class: "w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md transition-colors font-medium" %>
    <% else %>
      <%# 今日達成済みの場合: 達成完了メッセージを表示 %>
      <%# w-full: ボタンと同じ幅で統一感を保つ %>
      <%# bg-emerald-100: より薄い緑色で達成済み状態を表現 %>
      <div class="w-full bg-emerald-100 text-emerald-800 px-4 py-2 rounded-md text-center font-medium">
        今日は達成済みです ✅
      </div>
    <% end %>
  </div>

  <%# 操作ボタン群 - 編集・削除・戻る機能 %>
  <%# flex: 横並び配置, flex-wrap: 画面幅が狭い時は折り返し %>
  <div class="flex flex-wrap gap-3">
    
    <%# 編集ボタン - 投稿内容の編集ページへ遷移 %>
    <%= link_to "編集", edit_post_path(@post),
          class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors" %>
    
    <%# 削除ボタン - 投稿を完全削除（確認ダイアログ付き） %>
    <%# turbo_method: :delete: HTTP DELETE メソッドを使用 %>
    <%# turbo_confirm: JavaScript 確認ダイアログを表示 %>
    <%= link_to "削除", post_path(@post),
          data: {
            turbo_method: :delete,
            turbo_confirm: "本当に削除しますか？"
          },
          class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors" %>
    
    <%# 一覧戻りボタン - 投稿一覧ページに戻る %>
    <%= link_to "一覧に戻る", posts_path,
          class: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors" %>
  </div>
</div>