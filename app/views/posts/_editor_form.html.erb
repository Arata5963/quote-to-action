<%# app/views/posts/_editor_form.html.erb %>
<%# フルスクリーンエディタ形式の投稿フォーム %>

<div class="editor-fullscreen" data-controller="editor-form clipboard"
     data-clipboard-url-value="<%= post.youtube_url %>"
     data-editor-form-search-url-value="<%= search_for_comparison_posts_path %>">

  <%= form_with(model: post, local: true, html: { class: "editor-form" }) do |form| %>
    <%# ===== ヘッダー ===== %>
    <header class="editor-header">
      <div class="editor-header-left">
        <%= link_to posts_path, class: "editor-close-btn", data: { turbo_confirm: "編集内容が失われます。閉じますか？" } do %>
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          <span>閉じる</span>
        <% end %>
      </div>
      <div class="editor-header-right">
        <%= form.submit post.persisted? ? "更新する" : "記録する", class: "editor-submit-btn" %>
      </div>
    </header>

    <%# ===== メインコンテンツ ===== %>
    <main class="editor-main">
      <div class="editor-content">

        <%# エラーメッセージ表示 %>
        <% if post.errors.any? %>
          <div class="editor-error">
            <svg class="w-5 h-5 text-red-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
            <div>
              <% post.errors.full_messages.each do |message| %>
                <p><%= message %></p>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# ===== YouTube URL入力（統合検索） ===== %>
        <section class="editor-section">
          <div class="editor-youtube-input" data-controller="youtube-search"
               data-youtube-search-url-value="<%= youtube_search_posts_path %>">
            <label class="editor-label">
              <svg class="w-5 h-5 text-red-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
              </svg>
              YouTube動画
            </label>

            <%# 統合入力フィールド %>
            <div class="relative">
              <input type="text"
                     data-youtube-search-target="input"
                     data-action="input->youtube-search#handleInput focus->clipboard#checkClipboard"
                     data-clipboard-target="input"
                     value="<%= post.youtube_url %>"
                     placeholder="URLを貼り付け、またはタイトルで検索..."
                     class="editor-input pr-10">
              <div class="absolute right-3 top-1/2 -translate-y-1/2">
                <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
            </div>
            <p class="editor-hint">YouTube URLを貼り付けるか、タイトルで検索できます</p>

            <%# 検索結果 %>
            <div data-youtube-search-target="results" class="hidden editor-search-results"></div>

            <%# 隠しフィールド（フォーム送信用） %>
            <%= form.hidden_field :youtube_url, data: { youtube_search_target: "urlField" } %>

            <%# サムネイルプレビュー %>
            <div data-youtube-search-target="preview" class="editor-video-preview hidden">
              <button type="button"
                      data-action="click->youtube-search#clearSelection"
                      class="absolute top-2 right-2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-colors"
                      title="選択解除">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <img data-youtube-search-target="thumbnail" src="" alt="" class="editor-video-thumbnail">
              <div class="editor-video-info">
                <p data-youtube-search-target="title" class="editor-video-title"></p>
                <p data-youtube-search-target="channel" class="editor-video-channel"></p>
              </div>
            </div>
          </div>
        </section>

        <%# ===== アウトプット入力 ===== %>
        <section class="editor-section editor-output-section">
          <%# タブナビゲーション（要約/引用/アクション/布教/比較/ブログ） %>
          <div class="editor-tabs">
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="keyPoint"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-active">
              <span class="editor-tab-icon">📝</span>
              <span class="editor-tab-label">要約</span>
            </button>
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="quote"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-inactive">
              <span class="editor-tab-icon">💬</span>
              <span class="editor-tab-label">引用</span>
            </button>
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="action"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-inactive">
              <span class="editor-tab-icon">🎯</span>
              <span class="editor-tab-label">アクション</span>
            </button>
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="recommendation"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-inactive">
              <span class="editor-tab-icon">📣</span>
              <span class="editor-tab-label">布教</span>
            </button>
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="comparison"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-inactive">
              <span class="editor-tab-icon">⚖️</span>
              <span class="editor-tab-label">比較</span>
            </button>
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="blog"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-inactive">
              <span class="editor-tab-icon">📰</span>
              <span class="editor-tab-label">ブログ</span>
            </button>
            <button type="button"
                    data-editor-form-target="tab"
                    data-tab="quiz"
                    data-action="click->editor-form#switchTab"
                    class="editor-tab editor-tab-inactive">
              <span class="editor-tab-icon">🧠</span>
              <span class="editor-tab-label">クイズ</span>
            </button>
          </div>

          <%# エディタエリア（タブで切り替え） %>
          <div class="editor-area">
            <%# 要約エディタ %>
            <div data-editor-form-target="editor" data-editor-type="keyPoint" class="editor-panel">
              <textarea data-editor-form-target="keyPointContent"
                        data-action="keydown->editor-form#handleKeydown"
                        placeholder="この動画で学んだことを入力...

- 箇条書きも使えます
- マークダウン記法に対応予定"
                        rows="14"
                        class="editor-textarea editor-textarea-large"></textarea>
              <div class="editor-panel-footer">
                <button type="button"
                        data-action="click->editor-form#generateWithAI"
                        data-entry-type="keyPoint"
                        class="editor-ai-btn">
                  ✨ AIで生成
                </button>
                <span class="text-xs text-gray-400">Cmd/Ctrl + Enter で保存</span>
                <button type="button"
                        data-action="click->editor-form#saveEntry"
                        class="editor-save-btn">
                  保存
                </button>
              </div>
            </div>

            <%# 引用エディタ %>
            <div data-editor-form-target="editor" data-editor-type="quote" class="editor-panel" style="display: none;">
              <textarea data-editor-form-target="quoteContent"
                        data-action="keydown->editor-form#handleKeydown"
                        placeholder="動画の中で印象に残った言葉を入力..."
                        rows="5"
                        class="editor-textarea editor-textarea-quote"></textarea>
              <div class="editor-panel-footer">
                <button type="button"
                        data-action="click->editor-form#generateWithAI"
                        data-entry-type="quote"
                        class="editor-ai-btn">
                  ✨ AIで生成
                </button>
                <span class="text-xs text-gray-400">Cmd/Ctrl + Enter で保存</span>
                <button type="button"
                        data-action="click->editor-form#saveEntry"
                        class="editor-save-btn">
                  保存
                </button>
              </div>
            </div>

            <%# アクションエディタ %>
            <div data-editor-form-target="editor" data-editor-type="action" class="editor-panel" style="display: none;">
              <textarea data-editor-form-target="actionContent"
                        data-action="keydown->editor-form#handleKeydown"
                        placeholder="この動画を見て、具体的に何をしますか？"
                        rows="4"
                        class="editor-textarea"></textarea>
              <div class="editor-action-deadline">
                <label class="text-sm text-gray-600">期日（任意）</label>
                <input type="date"
                       data-editor-form-target="actionDeadline"
                       class="editor-date-input">
              </div>
              <div class="editor-panel-footer">
                <button type="button"
                        data-action="click->editor-form#generateWithAI"
                        data-entry-type="action"
                        class="editor-ai-btn">
                  ✨ AIで生成
                </button>
                <span class="text-xs text-gray-400">Cmd/Ctrl + Enter で保存</span>
                <button type="button"
                        data-action="click->editor-form#saveEntry"
                        class="editor-save-btn">
                  保存
                </button>
              </div>
            </div>

            <%# 布教エディタ %>
            <div data-editor-form-target="editor" data-editor-type="recommendation" class="editor-panel" style="display: none;">
              <div class="space-y-4">
                <%# おすすめ度 %>
                <div>
                  <label class="text-sm font-medium text-gray-700 mb-2 block">おすすめ度</label>
                  <div class="flex gap-2" data-controller="rating">
                    <% 5.times do |i| %>
                      <button type="button"
                              data-rating-target="button"
                              data-action="click->rating#select mouseenter->rating#hover mouseleave->rating#leave"
                              data-level="<%= i + 1 %>"
                              style="opacity: 0.3;"
                              class="text-2xl transition-opacity cursor-pointer">
                        🔥
                      </button>
                    <% end %>
                    <input type="hidden" data-rating-target="input" data-editor-form-target="recommendationLevel">
                  </div>
                </div>

                <%# おすすめポイント %>
                <div>
                  <label class="text-sm font-medium text-gray-700 mb-2 block">おすすめポイント</label>
                  <textarea data-editor-form-target="recommendationPoint"
                            data-action="keydown->editor-form#handleKeydown"
                            placeholder="この動画のおすすめポイントを記入...
例: ○○について初心者にもわかりやすく解説されている"
                            rows="4"
                            class="editor-textarea"></textarea>
                </div>

                <%# ターゲット視聴者 %>
                <div>
                  <label class="text-sm font-medium text-gray-700 mb-2 block">こんな人におすすめ（任意）</label>
                  <textarea data-editor-form-target="recommendationAudience"
                            placeholder="例: プログラミング初心者、副業を始めたい人"
                            rows="2"
                            class="editor-textarea"></textarea>
                </div>
              </div>

              <div class="editor-panel-footer">
                <span class="text-xs text-gray-400">Cmd/Ctrl + Enter で保存</span>
                <button type="button"
                        data-action="click->editor-form#saveEntry"
                        class="editor-save-btn">
                  保存
                </button>
              </div>
            </div>

            <%# 比較エディタ %>
            <div data-editor-form-target="editor" data-editor-type="comparison" class="editor-panel" style="display: none;">
              <div class="space-y-4">
                <%# 比較対象選択 %>
                <div>
                  <label class="text-sm font-medium text-gray-700 mb-2 block">比較する動画を選択</label>
                  <div class="relative">
                    <input type="text"
                           data-editor-form-target="comparisonSearch"
                           data-action="input->editor-form#searchComparison"
                           placeholder="動画タイトルで検索..."
                           class="editor-input">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2">
                      <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                      </svg>
                    </div>
                  </div>
                  <div data-editor-form-target="comparisonResults" class="hidden mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg"></div>
                </div>

                <%# 選択済み比較対象 %>
                <div data-editor-form-target="comparisonSelected" class="hidden">
                  <label class="text-sm font-medium text-gray-700 mb-2 block">選択中の動画</label>
                  <div data-editor-form-target="comparisonSelectedItem" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <!-- 動的に追加 -->
                  </div>
                </div>

                <%# 比較理由 %>
                <div>
                  <label class="text-sm font-medium text-gray-700 mb-2 block">比較理由（任意）</label>
                  <textarea data-editor-form-target="comparisonReason"
                            placeholder="例: 同じトピックについて別の視点から解説している"
                            rows="3"
                            class="editor-textarea"></textarea>
                </div>
              </div>

              <div class="editor-panel-footer">
                <span class="text-xs text-gray-400">比較対象を選択して保存</span>
                <button type="button"
                        data-action="click->editor-form#saveEntry"
                        class="editor-save-btn">
                  保存
                </button>
              </div>
            </div>

            <%# ブログエディタ %>
            <div data-editor-form-target="editor" data-editor-type="blog" class="editor-panel" style="display: none;" data-controller="blog-editor">
              <%# タイトル %>
              <div style="margin-bottom: 12px;">
                <input type="text"
                       name="blog_entry[title]"
                       data-editor-form-target="blogTitle"
                       placeholder="ブログのタイトル..."
                       style="width: 100%; padding: 12px; font-size: 16px; font-weight: 500; border: 1px solid #e5e7eb; border-radius: 8px;">
              </div>

              <%# 編集/プレビュー切り替え %>
              <div style="display: flex; gap: 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 12px;">
                <button type="button"
                        data-blog-editor-target="editTab"
                        data-action="blog-editor#showEdit"
                        class="active-tab"
                        style="padding: 8px 16px; font-size: 13px; background: none; border: none; cursor: pointer; position: relative;">
                  ✏️ 編集
                </button>
                <button type="button"
                        data-blog-editor-target="previewTab"
                        data-action="blog-editor#showPreview"
                        class="inactive-tab"
                        style="padding: 8px 16px; font-size: 13px; background: none; border: none; cursor: pointer; position: relative;">
                  👁️ プレビュー
                </button>
              </div>

              <%# 本文エディタ %>
              <div data-blog-editor-target="editor">
                <textarea name="blog_entry[content]"
                          data-editor-form-target="blogContent"
                          data-blog-editor-target="input"
                          placeholder="Markdown記法が使えます...

## 見出し
- 箇条書き
**太字** や *斜体* も使えます"
                          rows="12"
                          class="editor-textarea"
                          style="font-family: monospace;"></textarea>
              </div>

              <%# プレビュー %>
              <div data-blog-editor-target="preview"
                   class="hidden markdown-preview"
                   style="min-height: 250px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa;">
              </div>

              <%# フッター %>
              <div class="editor-panel-footer" style="justify-content: space-between;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6b7280;">
                  <input type="checkbox"
                         name="blog_entry[publish]"
                         value="true"
                         data-editor-form-target="blogPublish"
                         style="width: 14px; height: 14px;">
                  公開する
                </label>
                <button type="button"
                        data-action="click->editor-form#saveEntry"
                        class="editor-save-btn">
                  保存
                </button>
              </div>
            </div>

            <%# クイズパネル %>
            <div data-editor-form-target="editor" data-editor-type="quiz" class="editor-panel" style="display: none;" data-controller="quiz">
              <%# ローディング状態 %>
              <div data-quiz-target="loading" class="quiz-loading" style="display: none;">
                <div class="quiz-loading-spinner"></div>
                <p>クイズを読み込み中...</p>
              </div>

              <%# クイズ未生成状態（初期表示） %>
              <div data-quiz-target="empty" class="quiz-empty" style="display: flex;">
                <div class="quiz-empty-icon">🧠</div>
                <h3 class="quiz-empty-title">理解度チェッククイズ</h3>
                <p class="quiz-empty-description">AIがこの動画の内容に基づいて5問のクイズを生成します。</p>
                <button type="button"
                        data-action="click->quiz#generate"
                        class="quiz-generate-btn">
                  ✨ クイズを生成
                </button>
              </div>

              <%# クイズ問題表示 %>
              <div data-quiz-target="questions" class="quiz-questions" style="display: none;">
                <div class="quiz-header">
                  <span class="quiz-progress">
                    問題 <span data-quiz-target="currentQuestion">1</span> / <span data-quiz-target="totalQuestions">5</span>
                  </span>
                </div>

                <div data-quiz-target="questionContainer" class="quiz-question-container">
                  <%# 問題が動的に追加される %>
                </div>

                <div class="quiz-navigation">
                  <button type="button"
                          data-action="click->quiz#prevQuestion"
                          data-quiz-target="prevBtn"
                          class="quiz-nav-btn quiz-nav-prev"
                          disabled>
                    ← 前へ
                  </button>
                  <button type="button"
                          data-action="click->quiz#nextQuestion"
                          data-quiz-target="nextBtn"
                          class="quiz-nav-btn quiz-nav-next">
                    次へ →
                  </button>
                  <button type="button"
                          data-action="click->quiz#submit"
                          data-quiz-target="submitBtn"
                          class="quiz-submit-btn"
                          style="display: none;">
                    回答を送信
                  </button>
                </div>
              </div>

              <%# 回答済み状態 %>
              <div data-quiz-target="answered" class="quiz-answered" style="display: none;">
                <div class="quiz-answered-icon">✅</div>
                <h3 class="quiz-answered-title">回答済みです</h3>
                <p class="quiz-answered-score">
                  前回のスコア: <span data-quiz-target="lastScore">-</span>/<span data-quiz-target="lastTotal">5</span>
                </p>
                <button type="button"
                        data-action="click->quiz#retake"
                        class="quiz-retake-btn">
                  もう一度挑戦する
                </button>
              </div>

              <%# エラー状態 %>
              <div data-quiz-target="error" class="quiz-error" style="display: none;">
                <div class="quiz-error-icon">⚠️</div>
                <p data-quiz-target="errorMessage" class="quiz-error-message"></p>
                <button type="button"
                        data-action="click->quiz#retry"
                        class="quiz-retry-btn">
                  再試行
                </button>
              </div>
            </div>
          </div>

          <%# 保存済みアウトプット一覧（クイズタブでは非表示） %>
          <div class="editor-saved-section" data-editor-form-target="savedSection">
            <div class="editor-saved-header hidden">
              <span>保存済み</span>
              <span data-editor-form-target="savedCount" class="editor-saved-count">0</span>
            </div>
            <div data-editor-form-target="savedList" class="editor-saved-list">
              <div class="text-center py-8 text-gray-400">
                <p>まだアウトプットがありません</p>
                <p class="text-sm mt-1">上のエディタで入力して「保存」してください</p>
              </div>
            </div>
          </div>

          <%# 非表示フィールド（フォーム送信用） %>
          <div data-editor-form-target="hiddenEntries"></div>
        </section>

      </div>
    </main>
  <% end %>
</div>
